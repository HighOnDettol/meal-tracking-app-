<body>

    <div class="container no-print">
        <div class="header">
            <h1>Sishu Mangal Parsat</h1>
            <p>Golden Jubilee Celebration</p>
        </div>
        
        <h2>Meal Coupon Generator</h2>
        <p>Fill in the details below to generate a printable coupon or an image for WhatsApp.</p>

        <form id="input-form">
            <div class="form-group">
                <label for="school-name">School Name:</label>
                <input type="text" id="school-name" required>
            </div>
            <div class="form-group">
                <label for="contact-name">Contact Name (Mobile No. Owner):</label>
                <input type="text" id="contact-name" required>
            </div>
            <div class="form-group">
                <label for="mobile-no">Mobile Number:</label>
                <input type="tel" id="mobile-no" required>
            </div>
            
            <div class="form-group">
                <label for="breakfast-count">Number of Breakfasts:</label>
                <input type="number" id="breakfast-count" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="lunch-count">Number of Lunches:</label>
                <input type="number" id="lunch-count" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="dinner-count">Number of Tiffins:</label>
                <input type="number" id="dinner-count" min="0" value="0">
            </div>

            <div class="button-group">
                <button type="submit" id="generate-print-btn">Generate & Print</button>
                <button type="button" id="generate-image-btn">Generate Coupon Image</button>
            </div>
        </form>
    </div>

    <div id="coupon-template" style="position: absolute; left: -9999px; top: -9999px;">
        <div class="header">
            <h1>Sishu Mangal Parsat</h1>
            <p>Golden Jubilee Celebration</p>
        </div>
        <div class="coupon-body">
            <p>This coupon is for:</p>
            <p><strong>School Name:</strong> <span class="coupon-data" data-field="school-name"></span></p>
            <p><strong>Contact Person:</strong> <span class="coupon-data" data-field="contact-name"></span></p>
            <p><strong>Mobile No:</strong> <span class="coupon-data" data-field="mobile-no"></span></p>
            <div class="meal-counts">
                <div>
                    <p>Breakfast</p>
                    <span class="coupon-data highlight" data-field="breakfast-count">0</span>
                </div>
                <div>
                    <p>Lunch</p>
                    <span class="coupon-data highlight" data-field="lunch-count">0</span>
                </div>
                <div>
                    <p>Tiffin</p>
                    <span class="coupon-data highlight" data-field="dinner-count">0</span>
                </div>
            </div>
            <p style="margin-top: 20px; font-size: 0.8em;">Please present this coupon to receive your meals.</p>
        </div>
        <div class="coupon-footer">
            <p>Generated on: <span id="generation-date"></span></p>
            <span>&copy; Sishu Mangal Parsat</span>
        </div>
    </div>

    <div id="generated-image-display" class="no-print">
        <h3>Generated Coupon Image:</h3>
        <img id="coupon-image" src="" alt="Generated Meal Coupon">
        <p id="copy-instructions">Right-click (or long-press on mobile) the image above to copy it and paste into WhatsApp.</p>
    </div>
    
    <script>
        const formInputs = {
            'school-name': document.getElementById('school-name'),
            'contact-name': document.getElementById('contact-name'),
            'mobile-no': document.getElementById('mobile-no'),
            'breakfast-count': document.getElementById('breakfast-count'),
            'lunch-count': document.getElementById('lunch-count'),
            'dinner-count': document.getElementById('dinner-count')
        };

        const couponTemplate = document.getElementById('coupon-template');
        const generatedImageDisplay = document.getElementById('generated-image-display');
        const couponImageElement = document.getElementById('coupon-image');
        // Add this line to define the generationDateElement
        const generationDateElement = document.getElementById('generation-date');

        // Function to update the coupon template with current form data
        function updateCouponTemplate() {
            for (const field in formInputs) {
                const elements = couponTemplate.querySelectorAll(`.coupon-data[data-field="${field}"]`);
                elements.forEach(el => {
                    el.textContent = formInputs[field].value;
                });
            }
            const now = new Date();
            generationDateElement.textContent = now.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' ' + now.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Generate & Print button
        document.getElementById('generate-print-btn').addEventListener('click', function(event) {
            event.preventDefault();
            if (document.getElementById('input-form').checkValidity()) {
                updateCouponTemplate();
                // Temporarily make the template visible for printing purposes only
                couponTemplate.style.position = 'static';
                couponTemplate.style.left = 'auto';
                couponTemplate.style.top = 'auto';
                window.print();
                // Hide it again after printing
                couponTemplate.style.position = 'absolute';
                couponTemplate.style.left = '-9999px';
                couponTemplate.style.top = '-9999px';
                generatedImageDisplay.style.display = 'none'; // Hide image display if printing
            } else {
                alert('Please fill out all required fields.');
            }
        });

        // Generate Image button
        document.getElementById('generate-image-btn').addEventListener('click', function(event) {
            event.preventDefault();
            if (document.getElementById('input-form').checkValidity()) {
                updateCouponTemplate();

                // Temporarily make the coupon template visible for html2canvas
                couponTemplate.style.position = 'static';
                couponTemplate.style.left = 'auto';
                couponTemplate.style.top = 'auto';
                
                // Use a small timeout to ensure DOM has updated before screenshot
                setTimeout(() => {
                    html2canvas(couponTemplate, { 
                        scale: 3, // Increase resolution for better quality
                        backgroundColor: '#fff8e1' // Ensure background is captured
                    }).then(canvas => {
                        const imageData = canvas.toDataURL('image/png');
                        couponImageElement.src = imageData;
                        generatedImageDisplay.style.display = 'block';
                        
                        // Hide the coupon template again
                        couponTemplate.style.position = 'absolute';
                        couponTemplate.style.left = '-9999px';
                        couponTemplate.style.top = '-9999px';
                    });
                }, 50); 
            } else {
                alert('Please fill out all required fields.');
            }
        });

    </script>
</body>
</html>
